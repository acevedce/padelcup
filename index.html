<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium PadelCup 2.0 - Sistema de Gesti√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #2c5364;
            position: relative;
        }

        h1 {
            color: #0f2027;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            color: #555;
            font-size: 1.2em;
            font-style: italic;
        }

        .trophy-icon {
            font-size: 1.2em;
            color: #ffd700;
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .sponsor-container {
            position: absolute;
            right: 20px;
            top: 20px;
            text-align: center;
            max-width: 150px;
        }

        .sponsor-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-bottom: 5px;
        }

        .sponsor-text {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
        }

        .sponsor-link {
            color: #2c5364;
            text-decoration: none;
            font-weight: bold;
        }

        .sponsor-link:hover {
            text-decoration: underline;
        }

        .setup-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #2a5298;
        }

        .setup-section h2 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .setup-section ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-section code {
            background: #333;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background-color: #e0e0e0;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            top: 2px;
        }

        .tab:hover {
            background-color: #d0d0d0;
        }

        .tab.active {
            background-color: #2c5364;
            color: white;
            top: 0;
            padding-bottom: 14px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        h2 {
            color: #2c5364;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #203a43;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row > * {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5364;
            box-shadow: 0 0 0 3px rgba(44, 83, 100, 0.1);
        }

        button {
            background-color: #2c5364;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background-color: #203a43;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #2c5364;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .connected {
            background-color: #28a745;
            color: white;
        }

        .disconnected {
            background-color: #dc3545;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .ranking-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s;
        }

        .ranking-card:hover {
            transform: translateX(5px);
        }

        .ranking-position {
            font-size: 2em;
            font-weight: bold;
            color: #2c5364;
            width: 60px;
            text-align: center;
        }

        .ranking-position.gold {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .ranking-position.silver {
            color: #c0c0c0;
            text-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
        }

        .ranking-position.bronze {
            color: #cd7f32;
            text-shadow: 0 0 10px rgba(205, 127, 50, 0.5);
        }

        .partido-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .partido-info {
            flex-grow: 1;
        }

        .partido-resultado {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid #e0e0e0;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .sponsor-container {
                position: static;
                max-width: 100%;
                margin-bottom: 20px;
            }

            .tabs {
                gap: 2px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="connectionStatus" class="connection-status disconnected">Desconectado</div>
        
        <div class="header">

            
            <h1>
                <div class="sponsor-container">
                    <img src="./images/padelcup.jpeg" 
                        alt="Cup Logo" 
                        class="sponsor-logo">
                </div>
                    Premium PadelCup 2.0
                <div class="sponsor-container">
                    <img src="./images/ecav.jpeg" 
                        alt="ECAV Logo" 
                        class="sponsor-logo">
                    <p class="sponsor-text">
                        <a href="https://ecav.com.py" target="_blank" class="sponsor-link">ECAV.com.py</a>
                    </p>
                </div> 
            </h1>
            <p class="subtitle">Sistema de Gesti√≥n de Torneo - Edici√≥n Google Sheets</p>
        </div>

        <!-- Secci√≥n de configuraci√≥n de Google Sheets -->
        <div id="setupSection" class="setup-section">
            <h2>‚öôÔ∏è Configuraci√≥n Inicial - Google Sheets</h2>
            <p>Para usar esta aplicaci√≥n con Google Sheets como base de datos compartida, sigue estos pasos:</p>
            
            <ol>
                <li>Crea una nueva hoja de c√°lculo en Google Sheets</li>
                <li>En el men√∫, ve a <strong>Extensiones ‚Üí Apps Script</strong></li>
                <li>Borra todo el c√≥digo y pega el c√≥digo del archivo adjunto</li>
                <li>Guarda e implementa como aplicaci√≥n web</li>
                <li>Copia la URL de la aplicaci√≥n web</li>
            </ol>
            
            <div class="form-group">
                <label for="scriptUrl">URL de la aplicaci√≥n web de Google Apps Script:</label>
                <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" style="font-size: 14px;">
            </div>
            
            <button onclick="conectarGoogleSheets()" class="btn-success">üîó Conectar con Google Sheets</button>
            <button onclick="probarConexion()" style="background-color: #17a2b8; margin-left: 10px;">üß™ Probar Conexi√≥n</button>
        </div>

        <!-- Contenido principal (oculto hasta conectar) -->
        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <div class="tab active" onclick="showTab('configuracion')">‚öôÔ∏è Configuraci√≥n</div>
                <div class="tab" onclick="showTab('parejas')">üë• Parejas</div>
                <div class="tab" onclick="showTab('jornadas')">üìÖ Jornadas</div>
                <div class="tab" onclick="showTab('partidos')">üéæ Partidos</div>
                <div class="tab" onclick="showTab('ranking')">üèÖ Ranking</div>
            </div>

            <!-- Tab de Configuraci√≥n -->
            <div id="configuracion" class="tab-content active">
                <div class="section">
                    <h2>‚öôÔ∏è Configuraci√≥n del Torneo</h2>
                    
                    <div class="form-group">
                        <label for="formatoTorneo">Formato del Torneo:</label>
                        <select id="formatoTorneo" onchange="cambiarFormato()">
                            <option value="todos">Todos contra todos (Liga)</option>
                            <option value="grupos">Fase de grupos + Eliminatorias</option>
                            <option value="eliminacion">Eliminaci√≥n directa</option>
                        </select>
                    </div>

                    <div id="configTodos" class="formato-config">
                        <div class="info-box">
                            <strong>Liga - Todos contra todos:</strong> Cada pareja juega contra todas las dem√°s. 
                            El ganador se determina por puntos totales.
                        </div>
                        <div class="form-group">
                            <label for="puntosPorVictoria">Puntos por victoria:</label>
                            <input type="number" id="puntosPorVictoria" value="3" min="1">
                        </div>
                        <div class="form-group">
                            <label for="puntosPorEmpate">Puntos por empate (si aplica):</label>
                            <input type="number" id="puntosPorEmpate" value="1" min="0">
                        </div>
                    </div>

                    <div id="configGrupos" class="formato-config" style="display: none;">
                        <div class="info-box">
                            <strong>Fase de grupos:</strong> Las parejas se dividen en grupos. Los mejores de cada grupo 
                            avanzan a la fase eliminatoria.
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numeroGrupos">N√∫mero de grupos:</label>
                                <select id="numeroGrupos">
                                    <option value="2">2 grupos</option>
                                    <option value="4">4 grupos</option>
                                    <option value="8">8 grupos</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="clasificanPorGrupo">Clasifican por grupo:</label>
                                <select id="clasificanPorGrupo">
                                    <option value="1">1 pareja</option>
                                    <option value="2">2 parejas</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="configEliminacion" class="formato-config" style="display: none;">
                        <div class="info-box">
                            <strong>Eliminaci√≥n directa:</strong> Formato de torneo con eliminaci√≥n simple. 
                            El perdedor de cada partido queda eliminado.
                        </div>
                        <div class="form-group">
                            <label for="faseInicial">Fase inicial:</label>
                            <select id="faseInicial">
                                <option value="final">Final (2 parejas)</option>
                                <option value="semifinal">Semifinales (4 parejas)</option>
                                <option value="cuartos">Cuartos de final (8 parejas)</option>
                                <option value="octavos">Octavos de final (16 parejas)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="tercerPuesto" checked>
                            Partido por el tercer puesto
                        </label>
                    </div>

                    <button onclick="guardarConfiguracion()" class="btn-success">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>
            </div>

            <!-- Tab de Parejas -->
            <div id="parejas" class="tab-content">
                <div class="section">
                    <h2>üë• Registro de Parejas</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="jugador1">Jugador 1:</label>
                            <input type="text" id="jugador1" placeholder="Nombre del jugador 1">
                        </div>
                        <div class="form-group">
                            <label for="jugador2">Jugador 2:</label>
                            <input type="text" id="jugador2" placeholder="Nombre del jugador 2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="nombrePareja">Nombre de la pareja (opcional):</label>
                        <input type="text" id="nombrePareja" placeholder="Ej: Los Invencibles">
                    </div>
                    <button onclick="agregarPareja()">‚ûï Agregar Pareja</button>

                    <h3 style="margin-top: 30px;">Parejas Registradas</h3>
                    <div id="listaParejas" class="loading">Cargando parejas...</div>
                </div>
            </div>

            <!-- Tab de Jornadas -->
            <div id="jornadas" class="tab-content">
                <div class="section">
                    <h2>üìÖ Gesti√≥n de Jornadas</h2>
                    
                    <div class="form-group">
                        <button onclick="generarJornadas()" class="btn-success">
                            üé≤ Generar Jornadas Autom√°ticamente
                        </button>
                        <button onclick="mostrarFormularioJornada()" class="btn-secondary">
                            ‚ûï Agregar Jornada Manual
                        </button>
                    </div>

                    <!-- Formulario para agregar/editar jornada (oculto por defecto) -->
                    <div id="formularioJornada" style="display: none; margin-top: 20px; padding: 20px; background: #f0f8ff; border-radius: 8px;">
                        <h3 id="tituloFormularioJornada">Nueva Jornada</h3>
                        <input type="hidden" id="jornadaEditId">
                        
                        <div class="form-group">
                            <label for="nombreJornada">Nombre de la jornada:</label>
                            <input type="text" id="nombreJornada" placeholder="Ej: Jornada 1">
                        </div>
                        
                        <div class="form-group">
                            <label for="fechaJornada">Fecha de inicio (opcional):</label>
                            <input type="date" id="fechaJornada">
                        </div>
                        
                        <h4>Partidos de la jornada:</h4>
                        <div id="partidosJornada">
                            <!-- Aqu√≠ se agregar√°n din√°micamente los partidos -->
                        </div>
                        
                        <button onclick="agregarPartidoJornada()" class="btn-secondary">
                            ‚ûï Agregar Partido
                        </button>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="guardarJornada()" class="btn-success">
                                üíæ Guardar Jornada
                            </button>
                            <button onclick="cancelarFormularioJornada()" class="btn-secondary">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>

                    <div id="listaJornadas" class="loading">Cargando jornadas...</div>
                </div>
            </div>

            <!-- Tab de Partidos -->
            <div id="partidos" class="tab-content">
                <div class="section">
                    <h2>üéæ Registro de Partidos</h2>
                    
                    <div class="form-group">
                        <label for="jornadaPartido">Jornada:</label>
                        <select id="jornadaPartido" onchange="cargarPartidosDeJornada()">
                            <option value="">Selecciona una jornada</option>
                        </select>
                    </div>
                    
                    <div id="listaPartidosJornada" style="display: none;">
                        <h3>Partidos de la jornada:</h3>
                        <div id="partidosDisponibles"></div>
                    </div>

                    <h3 style="margin-top: 30px;">Historial de Partidos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Jornada</th>
                                <th>Fase</th>
                                <th>Pareja 1</th>
                                <th>Resultado</th>
                                <th>Pareja 2</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaPartidos">
                            <tr><td colspan="7" class="loading">Cargando partidos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab de Ranking -->
            <div id="ranking" class="tab-content">
                <div class="section">
                    <h2>üèÖ Ranking Individual</h2>
                    <div id="rankingIndividual" class="loading">Calculando ranking...</div>
                </div>

                <div class="section">
                    <h2>üéØ Ranking por Parejas</h2>
                    <div id="rankingParejas" class="loading">Calculando ranking...</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Premium PadelCup 2.0 ¬© 2024 - Desarrollado por <a href="https://ecav.com.py" target="_blank" class="sponsor-link">ECAV.com.py</a></p>
        </div>
    </div>

    <script>
        // Variables globales
        let scriptUrl = '';
        let configuracion = {};
        let parejas = [];
        let jornadas = [];
        let partidos = [];
        let callbackCounter = 0;

        // URL HARDCODEADA - Cambia esta l√≠nea con tu URL real de Google Apps Script
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5EYZ5LaJmI8OoavKsjOCI6V4a5j5r4sk6qkTW1nA32YPKpYYaoc0d-BzWccKj1YW4qg/exec';
        
        // Funci√≥n para hacer llamadas JSONP
        function jsonpRequest(url, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback' + (callbackCounter++);
                const script = document.createElement('script');
                
                // Definir callback global
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                // Configurar timeout
                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('Timeout en la petici√≥n'));
                }, 15000);
                
                // Construir URL con par√°metros
                const queryParams = new URLSearchParams(params);
                queryParams.append('callback', callbackName);
                const fullUrl = url + '?' + queryParams.toString();
                
                // Configurar y agregar script
                script.src = fullUrl;
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    reject(new Error('Error al cargar el script'));
                };
                
                document.body.appendChild(script);
            });
        }

        // Probar conexi√≥n
        async function probarConexion() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                alert('Por favor, ingresa la URL de Google Apps Script');
                return;
            }

            try {
                const result = await jsonpRequest(url, { action: 'test' });
                
                if (result.success) {
                    alert('‚úÖ ' + (result.message || 'Conexi√≥n exitosa'));
                } else {
                    alert('‚ùå Error: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        // Conectar con Google Sheets
        async function conectarGoogleSheets() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                alert('Por favor, ingresa la URL de Google Apps Script');
                return;
            }

            scriptUrl = url;
            localStorage.setItem('padelcup2_scriptUrl', scriptUrl);
            
            try {
                // Mostrar mensaje de carga
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                // Cargar configuraci√≥n
                const configResult = await jsonpRequest(scriptUrl, { action: 'getConfig' });
                if (configResult.success) {
                    configuracion = configResult.data;
                }
                
                // Actualizar estado
                document.getElementById('connectionStatus').textContent = 'Conectado';
                document.getElementById('connectionStatus').className = 'connection-status connected';
                
                // Cargar interfaz completa
                cargarInterfazCompleta();
                
            } catch (error) {
                alert('Error al conectar: ' + error.message);
                document.getElementById('setupSection').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            }
        }

        // Cargar interfaz completa
        async function cargarInterfazCompleta() {
            // Cargar configuraci√≥n
            document.getElementById('formatoTorneo').value = configuracion.formato || 'todos';
            document.getElementById('puntosPorVictoria').value = configuracion.puntosPorVictoria || 3;
            document.getElementById('puntosPorEmpate').value = configuracion.puntosPorEmpate || 1;
            document.getElementById('numeroGrupos').value = configuracion.numeroGrupos || 2;
            document.getElementById('clasificanPorGrupo').value = configuracion.clasificanPorGrupo || 2;
            document.getElementById('faseInicial').value = configuracion.faseInicial || 'cuartos';
            document.getElementById('tercerPuesto').checked = configuracion.tercerPuesto !== false;

            cambiarFormato();
            
            // Cargar datos
            await cargarTodosLosDatos();
        }

        // Inicializar al cargar
        window.onload = function() {
            // Primero intenta cargar URL guardada, si no existe usa la hardcodeada
            const savedUrl = localStorage.getItem('padelcup2_scriptUrl');
            const urlToUse = savedUrl || DEFAULT_SCRIPT_URL;
            
            document.getElementById('scriptUrl').value = urlToUse;
            
            // AUTOCONEXI√ìN: Si quieres que se conecte autom√°ticamente al cargar
            // descomenta la siguiente l√≠nea despu√©s de poner tu URL real:
            // if (urlToUse !== 'https://script.google.com/macros/s/TU_URL_AQUI/exec') { 
            //     conectarGoogleSheets(); 
            // }
        };

        // === FUNCIONES DE LA APLICACI√ìN ===

        // Mostrar tab
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Cambiar formato del torneo
        function cambiarFormato() {
            const formato = document.getElementById('formatoTorneo').value;
            document.querySelectorAll('.formato-config').forEach(el => {
                el.style.display = 'none';
            });

            if (formato === 'todos') {
                document.getElementById('configTodos').style.display = 'block';
            } else if (formato === 'grupos') {
                document.getElementById('configGrupos').style.display = 'block';
            } else if (formato === 'eliminacion') {
                document.getElementById('configEliminacion').style.display = 'block';
            }
        }

        // Guardar configuraci√≥n
        async function guardarConfiguracion() {
            const params = {
                action: 'saveConfig',
                formato: document.getElementById('formatoTorneo').value,
                puntosPorVictoria: document.getElementById('puntosPorVictoria').value,
                puntosPorEmpate: document.getElementById('puntosPorEmpate').value,
                numeroGrupos: document.getElementById('numeroGrupos').value,
                clasificanPorGrupo: document.getElementById('clasificanPorGrupo').value,
                faseInicial: document.getElementById('faseInicial').value,
                tercerPuesto: document.getElementById('tercerPuesto').checked
            };

            try {
                const result = await jsonpRequest(scriptUrl, params);
                if (result.success) {
                    mostrarMensaje('‚úÖ Configuraci√≥n guardada correctamente', 'success');
                    
                    // Actualizar configuraci√≥n local
                    configuracion = {
                        formato: params.formato,
                        puntosPorVictoria: parseInt(params.puntosPorVictoria),
                        puntosPorEmpate: parseInt(params.puntosPorEmpate),
                        numeroGrupos: parseInt(params.numeroGrupos),
                        clasificanPorGrupo: parseInt(params.clasificanPorGrupo),
                        faseInicial: params.faseInicial,
                        tercerPuesto: params.tercerPuesto
                    };
                }
            } catch (error) {
                mostrarMensaje('Error al guardar configuraci√≥n: ' + error.message, 'error');
            }
        }

        // Cargar todos los datos
        async function cargarTodosLosDatos() {
            try {
                // Cargar parejas
                const parejasResult = await jsonpRequest(scriptUrl, { action: 'getParejas' });
                if (parejasResult.success) {
                    parejas = parejasResult.data || [];
                    actualizarListaParejas();
                    actualizarSelectsParejas();
                }

                // Cargar jornadas
                const jornadasResult = await jsonpRequest(scriptUrl, { action: 'getJornadas' });
                if (jornadasResult.success) {
                    jornadas = jornadasResult.data || [];
                    actualizarListaJornadas();
                    actualizarSelectJornadas();
                }

                // Cargar partidos
                const partidosResult = await jsonpRequest(scriptUrl, { action: 'getPartidos' });
                if (partidosResult.success) {
                    partidos = partidosResult.data || [];
                    actualizarTablaPartidos();
                    actualizarRanking();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        // Agregar pareja
        async function agregarPareja() {
            const jugador1 = document.getElementById('jugador1').value.trim();
            const jugador2 = document.getElementById('jugador2').value.trim();
            const nombrePareja = document.getElementById('nombrePareja').value.trim();

            if (!jugador1 || !jugador2) {
                alert('Por favor, ingresa los nombres de ambos jugadores');
                return;
            }

            try {
                const params = {
                    action: 'addPareja',
                    jugador1: jugador1,
                    jugador2: jugador2,
                    nombre: nombrePareja
                };

                const result = await jsonpRequest(scriptUrl, params);
                
                if (result.success) {
                    document.getElementById('jugador1').value = '';
                    document.getElementById('jugador2').value = '';
                    document.getElementById('nombrePareja').value = '';
                    
                    mostrarMensaje('‚úÖ Pareja agregada correctamente', 'success');
                    await cargarTodosLosDatos();
                }
            } catch (error) {
                mostrarMensaje('Error al agregar pareja: ' + error.message, 'error');
            }
        }

        // Actualizar lista de parejas
        function actualizarListaParejas() {
            const lista = document.getElementById('listaParejas');
            
            if (parejas.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666;">No hay parejas registradas</p>';
                return;
            }

            let html = '<table><thead><tr><th>Nombre</th><th>Jugadores</th>';
            if (configuracion.formato === 'grupos') {
                html += '<th>Grupo</th>';
            }
            html += '<th>Acciones</th></tr></thead><tbody>';

            parejas.forEach(pareja => {
                html += `<tr>
                    <td><strong>${pareja.nombre}</strong></td>
                    <td>${pareja.jugador1} / ${pareja.jugador2}</td>`;
                
                if (configuracion.formato === 'grupos') {
                    html += `<td>${pareja.grupo || '-'}</td>`;
                }
                
                html += `<td>
                        <button onclick="eliminarPareja('${pareja.id}')" class="btn-danger">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            lista.innerHTML = html;
        }

        // Actualizar selects de parejas
        function actualizarSelectsParejas() {
            const selects = ['pareja1', 'pareja2'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecciona una pareja</option>';
                    parejas.forEach(pareja => {
                        select.innerHTML += `<option value="${pareja.id}">${pareja.nombre}</option>`;
                    });
                }
            });
        }

        // Eliminar pareja
        async function eliminarPareja(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta pareja? Se eliminar√°n tambi√©n sus partidos.')) {
                return;
            }

            try {
                const result = await jsonpRequest(scriptUrl, { action: 'deletePareja', id: id });
                
                if (result.success) {
                    mostrarMensaje('‚úÖ Pareja eliminada correctamente', 'success');
                    await cargarTodosLosDatos();
                }
            } catch (error) {
                mostrarMensaje('Error al eliminar pareja: ' + error.message, 'error');
            }
        }

        // Generar jornadas
        async function generarJornadas() {
            if (parejas.length < 2) {
                alert('Necesitas al menos 2 parejas para generar jornadas');
                return;
            }

            if (!confirm('¬øDeseas generar las jornadas autom√°ticamente? Esto eliminar√° las jornadas existentes.')) {
                return;
            }

            try {
                mostrarMensaje('Generando jornadas...', 'info');
                
                const result = await jsonpRequest(scriptUrl, { action: 'generarJornadas' });
                
                if (result.success) {
                    mostrarMensaje('‚úÖ Jornadas generadas correctamente', 'success');
                    await cargarTodosLosDatos();
                }
            } catch (error) {
                mostrarMensaje('Error al generar jornadas: ' + error.message, 'error');
            }
        }

        // Mostrar formulario de jornada
        function mostrarFormularioJornada() {
            document.getElementById('formularioJornada').style.display = 'block';
            document.getElementById('tituloFormularioJornada').textContent = 'Nueva Jornada';
            document.getElementById('jornadaEditId').value = '';
            document.getElementById('nombreJornada').value = '';
            document.getElementById('fechaJornada').value = '';
            document.getElementById('partidosJornada').innerHTML = '';
            
            // Agregar primer partido por defecto
            agregarPartidoJornada();
        }

        // Cancelar formulario de jornada
        function cancelarFormularioJornada() {
            document.getElementById('formularioJornada').style.display = 'none';
        }

        // Contador para partidos temporales
        let contadorPartidosTemp = 0;

        // Agregar partido a la jornada
        function agregarPartidoJornada() {
            const contenedor = document.getElementById('partidosJornada');
            const idTemp = 'partido_' + (contadorPartidosTemp++);
            
            const partidoDiv = document.createElement('div');
            partidoDiv.id = idTemp;
            partidoDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-radius: 5px;';
            
            let opcionesParejas = '<option value="">Selecciona pareja</option>';
            parejas.forEach(pareja => {
                opcionesParejas += `<option value="${pareja.id}">${pareja.nombre}</option>`;
            });
            
            partidoDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Pareja 1:</label>
                        <select class="pareja1-jornada">
                            ${opcionesParejas}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pareja 2:</label>
                        <select class="pareja2-jornada">
                            ${opcionesParejas}
                        </select>
                    </div>
                    <button onclick="quitarPartidoJornada('${idTemp}')" class="btn-danger" style="margin-top: 25px;">
                        ‚ùå Quitar
                    </button>
                </div>
            `;
            
            contenedor.appendChild(partidoDiv);
        }

        // Quitar partido de la jornada
        function quitarPartidoJornada(idTemp) {
            const elemento = document.getElementById(idTemp);
            if (elemento) {
                elemento.remove();
            }
        }

        // Guardar jornada
        async function guardarJornada() {
            const jornadaEditId = document.getElementById('jornadaEditId').value;
            const nombre = document.getElementById('nombreJornada').value.trim();
            const fecha = document.getElementById('fechaJornada').value;
            
            if (!nombre) {
                alert('Por favor, ingresa el nombre de la jornada');
                return;
            }
            
            // Recopilar partidos
            const partidosElements = document.querySelectorAll('#partidosJornada > div');
            const partidosJornada = [];
            
            for (let elemento of partidosElements) {
                const pareja1Id = elemento.querySelector('.pareja1-jornada').value;
                const pareja2Id = elemento.querySelector('.pareja2-jornada').value;
                
                if (pareja1Id && pareja2Id) {
                    if (pareja1Id === pareja2Id) {
                        alert('Una pareja no puede jugar contra s√≠ misma');
                        return;
                    }
                    
                    const pareja1 = parejas.find(p => p.id === pareja1Id);
                    const pareja2 = parejas.find(p => p.id === pareja2Id);
                    
                    partidosJornada.push({
                        pareja1: pareja1,
                        pareja2: pareja2
                    });
                }
            }
            
            try {
                if (jornadaEditId) {
                    // Actualizar jornada existente
                    const result = await jsonpRequest(scriptUrl, {
                        action: 'updateJornada',
                        id: jornadaEditId,
                        nombre: nombre,
                        fecha: fecha,
                        partidos: JSON.stringify(partidosJornada)
                    });
                    
                    if (result.success) {
                        mostrarMensaje('‚úÖ Jornada actualizada correctamente', 'success');
                    }
                } else {
                    // Crear nueva jornada
                    const result = await jsonpRequest(scriptUrl, {
                        action: 'addJornada',
                        nombre: nombre,
                        fecha: fecha,
                        partidos: JSON.stringify(partidosJornada)
                    });
                    
                    if (result.success) {
                        mostrarMensaje('‚úÖ Jornada creada correctamente', 'success');
                    }
                }
                
                cancelarFormularioJornada();
                await cargarTodosLosDatos();
                
            } catch (error) {
                mostrarMensaje('Error al guardar jornada: ' + error.message, 'error');
            }
        }

        // Editar jornada
        async function editarJornada(id) {
            const jornada = jornadas.find(j => j.id === id);
            if (!jornada) return;
            
            // Mostrar formulario
            document.getElementById('formularioJornada').style.display = 'block';
            document.getElementById('tituloFormularioJornada').textContent = 'Editar Jornada';
            document.getElementById('jornadaEditId').value = jornada.id;
            document.getElementById('nombreJornada').value = jornada.nombre;
            document.getElementById('fechaJornada').value = jornada.fecha || '';
            
            // Limpiar partidos actuales
            document.getElementById('partidosJornada').innerHTML = '';
            contadorPartidosTemp = 0;
            
            // Cargar partidos existentes
            if (jornada.partidos && jornada.partidos.length > 0) {
                jornada.partidos.forEach(partido => {
                    agregarPartidoJornada();
                    const ultimoPartido = document.querySelector('#partidosJornada > div:last-child');
                    ultimoPartido.querySelector('.pareja1-jornada').value = partido.pareja1.id;
                    ultimoPartido.querySelector('.pareja2-jornada').value = partido.pareja2.id;
                });
            } else {
                // Si no hay partidos, agregar uno vac√≠o
                agregarPartidoJornada();
            }
            
            // Hacer scroll al formulario
            document.getElementById('formularioJornada').scrollIntoView({ behavior: 'smooth' });
        }

        // Actualizar lista de jornadas
        function actualizarListaJornadas() {
            const lista = document.getElementById('listaJornadas');
            
            if (jornadas.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666;">No hay jornadas programadas</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table><thead><tr><th>Jornada</th><th>Fecha Inicio</th><th>Partidos</th><th>Acciones</th></tr></thead><tbody>';
            
            jornadas.forEach(jornada => {
                const numPartidos = jornada.partidos ? jornada.partidos.length : 0;
                const fecha = jornada.fecha ? new Date(jornada.fecha).toLocaleDateString('es-ES') : '-';
                
                html += `<tr>
                    <td><strong>${jornada.nombre}</strong></td>
                    <td>${fecha}</td>
                    <td>${numPartidos} partidos</td>
                    <td>
                        <button onclick="editarJornada('${jornada.id}')" class="btn-warning">‚úèÔ∏è Editar</button>
                        <button onclick="eliminarJornada('${jornada.id}')" class="btn-danger">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>`;
                
                // Mostrar partidos de la jornada con resultados
                if (jornada.partidos && jornada.partidos.length > 0) {
                    html += '<tr><td colspan="4"><table style="width: 100%; margin: 10px 0;">';
                    html += '<thead><tr><th>Pareja 1</th><th>vs</th><th>Pareja 2</th><th>Resultado</th><th>Fecha Partido</th></tr></thead><tbody>';
                    
                    jornada.partidos.forEach(partidoJornada => {
                        // Buscar si este partido tiene resultado registrado
                        const partidoConResultado = partidos.find(p => 
                            p.jornadaId === jornada.id && 
                            p.pareja1Id === partidoJornada.pareja1.id && 
                            p.pareja2Id === partidoJornada.pareja2.id
                        );
                        
                        let resultadoHTML = '';
                        let estiloGanador1 = '';
                        let estiloGanador2 = '';
                        let fechaPartido = '-';
                        
                        if (partidoConResultado) {
                            if (partidoConResultado.resultado1 && partidoConResultado.resultado2) {
                                resultadoHTML = `${partidoConResultado.resultado1} - ${partidoConResultado.resultado2}`;
                                
                                if (partidoConResultado.ganadorId === partidoJornada.pareja1.id) {
                                    estiloGanador1 = 'style="color: #28a745; font-weight: bold;"';
                                } else if (partidoConResultado.ganadorId === partidoJornada.pareja2.id) {
                                    estiloGanador2 = 'style="color: #28a745; font-weight: bold;"';
                                }
                            } else {
                                resultadoHTML = '<em>Pendiente</em>';
                            }
                            
                            if (partidoConResultado.fecha) {
                                fechaPartido = new Date(partidoConResultado.fecha).toLocaleDateString('es-ES');
                            }
                        } else {
                            resultadoHTML = '<em>Sin registrar</em>';
                        }
                        
                        html += `<tr>
                            <td ${estiloGanador1}>${partidoJornada.pareja1.nombre}</td>
                            <td style="text-align: center;">vs</td>
                            <td ${estiloGanador2}>${partidoJornada.pareja2.nombre}</td>
                            <td style="text-align: center;">${resultadoHTML}</td>
                            <td style="text-align: center;">${fechaPartido}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></td></tr>';
                }
            });
            
            html += '</tbody></table></div>';
            lista.innerHTML = html;
        }

        // Actualizar select de jornadas
        function actualizarSelectJornadas() {
            const select = document.getElementById('jornadaPartido');
            if (select) {
                select.innerHTML = '<option value="">Selecciona una jornada</option>';
                jornadas.forEach(jornada => {
                    select.innerHTML += `<option value="${jornada.id}">${jornada.nombre}</option>`;
                });
            }
        }

        // Eliminar jornada
        async function eliminarJornada(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta jornada?')) {
                return;
            }

            try {
                const result = await jsonpRequest(scriptUrl, { action: 'deleteJornada', id: id });
                
                if (result.success) {
                    mostrarMensaje('‚úÖ Jornada eliminada correctamente', 'success');
                    await cargarTodosLosDatos();
                }
            } catch (error) {
                mostrarMensaje('Error al eliminar jornada: ' + error.message, 'error');
            }
        }

        // Cargar partidos de jornada seleccionada
        function cargarPartidosDeJornada() {
            const jornadaId = document.getElementById('jornadaPartido').value;
            const contenedor = document.getElementById('partidosDisponibles');
            
            if (!jornadaId) {
                document.getElementById('listaPartidosJornada').style.display = 'none';
                return;
            }
            
            const jornada = jornadas.find(j => j.id === jornadaId);
            if (!jornada || !jornada.partidos || jornada.partidos.length === 0) {
                contenedor.innerHTML = '<p style="color: #666;">Esta jornada no tiene partidos definidos</p>';
                document.getElementById('listaPartidosJornada').style.display = 'block';
                return;
            }
            
            let html = '';
            jornada.partidos.forEach((partidoJornada, index) => {
                // Buscar si ya existe resultado
                const partidoExistente = partidos.find(p => 
                    p.jornadaId === jornadaId && 
                    p.pareja1Id === partidoJornada.pareja1.id && 
                    p.pareja2Id === partidoJornada.pareja2.id
                );
                
                const yaRegistrado = partidoExistente && partidoExistente.resultado1 && partidoExistente.resultado2;
                
                html += `<div class="partido-card">
                    <div class="partido-info">
                        <strong>${partidoJornada.pareja1.nombre}</strong> vs <strong>${partidoJornada.pareja2.nombre}</strong>
                        ${yaRegistrado ? `<span style="color: #28a745; margin-left: 10px;">‚úÖ Registrado (${partidoExistente.resultado1} - ${partidoExistente.resultado2})</span>` : ''}
                    </div>
                    <button onclick="registrarResultadoPartido('${jornadaId}', '${partidoJornada.pareja1.id}', '${partidoJornada.pareja2.id}', '${partidoJornada.pareja1.nombre}', '${partidoJornada.pareja2.nombre}'${partidoExistente ? ", '" + partidoExistente.id + "'" : ''})" 
                            class="${yaRegistrado ? 'btn-warning' : 'btn-success'}">
                        ${yaRegistrado ? '‚úèÔ∏è Editar Resultado' : 'üìù Registrar Resultado'}
                    </button>
                </div>`;
            });
            
            contenedor.innerHTML = html;
            document.getElementById('listaPartidosJornada').style.display = 'block';
        }

        // Registrar resultado de partido espec√≠fico
        async function registrarResultadoPartido(jornadaId, pareja1Id, pareja2Id, nombre1, nombre2, partidoId = null) {
            // Crear un mini formulario para el resultado
            const html = `
                <div style="padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3>Registrar Resultado</h3>
                    <p><strong>${nombre1}</strong> vs <strong>${nombre2}</strong></p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha del partido:</label>
                            <input type="datetime-local" id="fechaPartidoModal" value="${new Date().toISOString().slice(0,16)}">
                        </div>
                        <div class="form-group">
                            <label>Pista:</label>
                            <input type="text" id="pistaPartidoModal" placeholder="Ej: Pista 1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Resultado ${nombre1}:</label>
                            <input type="text" id="resultado1Modal" placeholder="Ej: 6-4 7-5">
                        </div>
                        <div class="form-group">
                            <label>Resultado ${nombre2}:</label>
                            <input type="text" id="resultado2Modal" placeholder="Ej: 4-6 5-7">
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="cerrarModalResultado()" class="btn-secondary">Cancelar</button>
                        <button onclick="guardarResultadoPartido('${jornadaId}', '${pareja1Id}', '${pareja2Id}', ${partidoId ? "'" + partidoId + "'" : 'null'})" class="btn-success">Guardar</button>
                    </div>
                </div>
            `;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'modalResultado';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = html;
            
            document.body.appendChild(modal);
            
            // Si es edici√≥n, cargar datos existentes
            if (partidoId) {
                const partido = partidos.find(p => p.id === partidoId);
                if (partido) {
                    document.getElementById('fechaPartidoModal').value = partido.fecha || '';
                    document.getElementById('pistaPartidoModal').value = partido.pista || '';
                    document.getElementById('resultado1Modal').value = partido.resultado1 || '';
                    document.getElementById('resultado2Modal').value = partido.resultado2 || '';
                }
            }
        }

        // Cerrar modal de resultado
        function cerrarModalResultado() {
            const modal = document.getElementById('modalResultado');
            if (modal) {
                modal.remove();
            }
        }

        // Guardar resultado de partido
        async function guardarResultadoPartido(jornadaId, pareja1Id, pareja2Id, partidoId) {
            const fecha = document.getElementById('fechaPartidoModal').value;
            const pista = document.getElementById('pistaPartidoModal').value;
            const resultado1 = document.getElementById('resultado1Modal').value.trim();
            const resultado2 = document.getElementById('resultado2Modal').value.trim();
            
            if (!resultado1 || !resultado2) {
                alert('Por favor, ingresa ambos resultados');
                return;
            }
            
            // Calcular ganador
            let ganadorId = '';
            const sets1 = contarSetsGanados(resultado1);
            const sets2 = contarSetsGanados(resultado2);
            ganadorId = sets1 > sets2 ? pareja1Id : pareja2Id;
            
            try {
                const params = {
                    action: partidoId ? 'updatePartido' : 'addPartido',
                    jornadaId: jornadaId,
                    fase: 'grupos', // Ajustar seg√∫n necesidad
                    fecha: fecha,
                    pista: pista,
                    pareja1Id: pareja1Id,
                    pareja2Id: pareja2Id,
                    resultado1: resultado1,
                    resultado2: resultado2,
                    ganadorId: ganadorId
                };
                
                if (partidoId) {
                    params.id = partidoId;
                }

                const result = await jsonpRequest(scriptUrl, params);
                
                if (result.success) {
                    cerrarModalResultado();
                    mostrarMensaje('‚úÖ Resultado registrado correctamente', 'success');
                    await cargarTodosLosDatos();
                    cargarPartidosDeJornada(); // Actualizar vista
                }
            } catch (error) {
                mostrarMensaje('Error al registrar resultado: ' + error.message, 'error');
            }
        }

        // Contar sets ganados
        function contarSetsGanados(resultado) {
            const sets = resultado.split(' ');
            let setsGanados = 0;
            
            sets.forEach(set => {
                const games = set.split('-');
                if (games.length === 2 && parseInt(games[0]) > parseInt(games[1])) {
                    setsGanados++;
                }
            });
            
            return setsGanados;
        }

        // Actualizar tabla de partidos
        function actualizarTablaPartidos() {
            const tbody = document.getElementById('listaPartidos');
            
            if (partidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No hay partidos registrados</td></tr>';
                return;
            }

            let html = '';
            
            // Ordenar partidos por fecha (m√°s recientes primero)
            const partidosOrdenados = [...partidos].sort((a, b) => {
                if (a.fecha && b.fecha) {
                    return new Date(b.fecha) - new Date(a.fecha);
                }
                return 0;
            });
            
            partidosOrdenados.forEach(partido => {
                const pareja1 = parejas.find(p => p.id === partido.pareja1Id);
                const pareja2 = parejas.find(p => p.id === partido.pareja2Id);
                const jornada = jornadas.find(j => j.id === partido.jornadaId);
                
                if (!pareja1 || !pareja2) return;

                const esGanador1 = partido.ganadorId && partido.ganadorId === partido.pareja1Id;
                const esGanador2 = partido.ganadorId && partido.ganadorId === partido.pareja2Id;

                html += `<tr>
                    <td>${partido.fecha ? new Date(partido.fecha).toLocaleString('es-ES') : '-'}</td>
                    <td>${jornada ? jornada.nombre : '-'}</td>
                    <td>${obtenerNombreFase(partido.fase)}</td>
                    <td class="${esGanador1 ? 'ganador' : ''}" style="${esGanador1 ? 'color: #28a745; font-weight: bold;' : ''}">
                        ${pareja1.nombre}
                    </td>
                    <td style="text-align: center;">
                        ${partido.resultado1 || '-'} | ${partido.resultado2 || '-'}
                    </td>
                    <td class="${esGanador2 ? 'ganador' : ''}" style="${esGanador2 ? 'color: #28a745; font-weight: bold;' : ''}">
                        ${pareja2.nombre}
                    </td>
                    <td>
                        <button onclick="editarPartido('${partido.id}')" class="btn-warning">‚úèÔ∏è</button>
                        <button onclick="eliminarPartido('${partido.id}')" class="btn-danger">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; color: #666;">No hay partidos registrados</td></tr>';
        }

        // Obtener nombre de fase
        function obtenerNombreFase(fase) {
            const fases = {
                'grupos': 'Grupos',
                'octavos': 'Octavos',
                'cuartos': 'Cuartos',
                'semifinal': 'Semifinal',
                'final': 'Final',
                'tercero': '3er Puesto'
            };
            return fases[fase] || fase;
        }

        // Editar partido
        async function editarPartido(id) {
            const partido = partidos.find(p => p.id === id);
            if (!partido) return;
            
            const pareja1 = parejas.find(p => p.id === partido.pareja1Id);
            const pareja2 = parejas.find(p => p.id === partido.pareja2Id);
            
            if (!pareja1 || !pareja2) return;
            
            registrarResultadoPartido(
                partido.jornadaId,
                partido.pareja1Id,
                partido.pareja2Id,
                pareja1.nombre,
                pareja2.nombre,
                partido.id
            );
        }

        // Eliminar partido
        async function eliminarPartido(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este partido?')) {
                return;
            }

            try {
                const result = await jsonpRequest(scriptUrl, { action: 'deletePartido', id: id });
                
                if (result.success) {
                    mostrarMensaje('‚úÖ Partido eliminado correctamente', 'success');
                    await cargarTodosLosDatos();
                }
            } catch (error) {
                mostrarMensaje('Error al eliminar partido: ' + error.message, 'error');
            }
        }

        // Actualizar ranking
        function actualizarRanking() {
            actualizarRankingIndividual();
            actualizarRankingParejas();
        }

        // Actualizar ranking individual
        function actualizarRankingIndividual() {
            const jugadores = {};

            partidos.forEach(partido => {
                if (!partido.resultado1 || !partido.resultado2 || !partido.ganadorId) return;

                const pareja1 = parejas.find(p => p.id === partido.pareja1Id);
                const pareja2 = parejas.find(p => p.id === partido.pareja2Id);
                
                if (!pareja1 || !pareja2) return;

                // Procesar jugadores de pareja 1
                [pareja1.jugador1, pareja1.jugador2].forEach(jugador => {
                    if (!jugador) return;
                    
                    if (!jugadores[jugador]) {
                        jugadores[jugador] = { 
                            nombre: jugador, 
                            victorias: 0, 
                            derrotas: 0, 
                            partidos: 0,
                            setsGanados: 0,
                            setsPerdidos: 0
                        };
                    }
                    
                    jugadores[jugador].partidos++;
                    
                    const sets1 = contarSetsGanados(partido.resultado1);
                    const sets2 = contarSetsGanados(partido.resultado2);
                    
                    jugadores[jugador].setsGanados += sets1;
                    jugadores[jugador].setsPerdidos += sets2;
                    
                    if (partido.ganadorId === partido.pareja1Id) {
                        jugadores[jugador].victorias++;
                    } else {
                        jugadores[jugador].derrotas++;
                    }
                });

                // Procesar jugadores de pareja 2
                [pareja2.jugador1, pareja2.jugador2].forEach(jugador => {
                    if (!jugador) return;
                    
                    if (!jugadores[jugador]) {
                        jugadores[jugador] = { 
                            nombre: jugador, 
                            victorias: 0, 
                            derrotas: 0, 
                            partidos: 0,
                            setsGanados: 0,
                            setsPerdidos: 0
                        };
                    }
                    
                    jugadores[jugador].partidos++;
                    
                    const sets1 = contarSetsGanados(partido.resultado1);
                    const sets2 = contarSetsGanados(partido.resultado2);
                    
                    jugadores[jugador].setsGanados += sets2;
                    jugadores[jugador].setsPerdidos += sets1;
                    
                    if (partido.ganadorId === partido.pareja2Id) {
                        jugadores[jugador].victorias++;
                    } else {
                        jugadores[jugador].derrotas++;
                    }
                });
            });

            const divRanking = document.getElementById('rankingIndividual');
            const rankingOrdenado = Object.values(jugadores)
                .sort((a, b) => {
                    // Ordenar por victorias, luego por diferencia de sets
                    if (a.victorias !== b.victorias) return b.victorias - a.victorias;
                    const difSetsA = a.setsGanados - a.setsPerdidos;
                    const difSetsB = b.setsGanados - b.setsPerdidos;
                    return difSetsB - difSetsA;
                });

            if (rankingOrdenado.length === 0) {
                divRanking.innerHTML = '<p style="text-align: center; color: #666;">No hay datos para mostrar el ranking</p>';
                return;
            }

            let html = '';
            rankingOrdenado.forEach((jugador, index) => {
                const porcentaje = jugador.partidos > 0 
                    ? Math.round((jugador.victorias / jugador.partidos) * 100) 
                    : 0;
                const positionClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const difSets = jugador.setsGanados - jugador.setsPerdidos;
                
                html += `<div class="ranking-card">
                    <div class="ranking-position ${positionClass}">#${index + 1}</div>
                    <div style="flex-grow: 1;">
                        <div style="font-size: 1.2em; font-weight: 500;">${jugador.nombre}</div>
                        <div style="color: #666; font-size: 0.9em;">
                            ${jugador.victorias}V - ${jugador.derrotas}D (${porcentaje}%) | Sets: ${jugador.setsGanados}-${jugador.setsPerdidos} (${difSets > 0 ? '+' : ''}${difSets})
                        </div>
                    </div>
                </div>`;
            });

            divRanking.innerHTML = html;
        }

        // Actualizar ranking de parejas
        function actualizarRankingParejas() {
            const estadisticasParejas = {};

            partidos.forEach(partido => {
                if (!partido.resultado1 || !partido.resultado2 || !partido.ganadorId) return;

                const pareja1 = parejas.find(p => p.id === partido.pareja1Id);
                const pareja2 = parejas.find(p => p.id === partido.pareja2Id);
                
                if (!pareja1 || !pareja2) return;

                // Procesar pareja 1
                if (!estadisticasParejas[pareja1.id]) {
                    estadisticasParejas[pareja1.id] = {
                        pareja: pareja1,
                        victorias: 0,
                        derrotas: 0,
                        puntos: 0,
                        setsGanados: 0,
                        setsPerdidos: 0
                    };
                }

                const sets1 = contarSetsGanados(partido.resultado1);
                const sets2 = contarSetsGanados(partido.resultado2);
                
                estadisticasParejas[pareja1.id].setsGanados += sets1;
                estadisticasParejas[pareja1.id].setsPerdidos += sets2;

                if (partido.ganadorId === partido.pareja1Id) {
                    estadisticasParejas[pareja1.id].victorias++;
                    estadisticasParejas[pareja1.id].puntos += configuracion.puntosPorVictoria || 3;
                } else {
                    estadisticasParejas[pareja1.id].derrotas++;
                }

                // Procesar pareja 2
                if (!estadisticasParejas[pareja2.id]) {
                    estadisticasParejas[pareja2.id] = {
                        pareja: pareja2,
                        victorias: 0,
                        derrotas: 0,
                        puntos: 0,
                        setsGanados: 0,
                        setsPerdidos: 0
                    };
                }

                estadisticasParejas[pareja2.id].setsGanados += sets2;
                estadisticasParejas[pareja2.id].setsPerdidos += sets1;

                if (partido.ganadorId === partido.pareja2Id) {
                    estadisticasParejas[pareja2.id].victorias++;
                    estadisticasParejas[pareja2.id].puntos += configuracion.puntosPorVictoria || 3;
                } else {
                    estadisticasParejas[pareja2.id].derrotas++;
                }
            });

            const divRanking = document.getElementById('rankingParejas');
            
            if (Object.keys(estadisticasParejas).length === 0) {
                divRanking.innerHTML = '<p style="text-align: center; color: #666;">No hay datos de parejas</p>';
                return;
            }

            // Ordenar por puntos, luego por victorias, luego por diferencia de sets
            const rankingOrdenado = Object.values(estadisticasParejas)
                .sort((a, b) => {
                    if (a.puntos !== b.puntos) return b.puntos - a.puntos;
                    if (a.victorias !== b.victorias) return b.victorias - a.victorias;
                    const difSetsA = a.setsGanados - a.setsPerdidos;
                    const difSetsB = b.setsGanados - b.setsPerdidos;
                    return difSetsB - difSetsA;
                });

            let html = '<table><thead><tr><th>Pos</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Sets</th><th>Puntos</th></tr></thead><tbody>';
            
            rankingOrdenado.forEach((stats, index) => {
                const totalPartidos = stats.victorias + stats.derrotas;
                const difSets = stats.setsGanados - stats.setsPerdidos;
                
                html += `<tr ${index < 2 ? 'style="background-color: #e8f5e9;"' : ''}>
                    <td><strong>${index + 1}</strong></td>
                    <td>${stats.pareja.nombre}</td>
                    <td>${totalPartidos}</td>
                    <td style="color: #28a745;">${stats.victorias}</td>
                    <td style="color: #dc3545;">${stats.derrotas}</td>
                    <td>${stats.setsGanados}-${stats.setsPerdidos} (${difSets > 0 ? '+' : ''}${difSets})</td>
                    <td><strong>${stats.puntos}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            divRanking.innerHTML = html;
        }

        // Mostrar mensaje
        function mostrarMensaje(mensaje, tipo) {
            const div = document.createElement('div');
            div.className = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'info-box';
            div.textContent = mensaje;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.left = '50%';
            div.style.transform = 'translateX(-50%)';
            div.style.zIndex = '2000';
            div.style.minWidth = '300px';
            div.style.textAlign = 'center';
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }
    </script>
</body>
</html>
